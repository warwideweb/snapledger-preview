<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Your smart screenshot stash">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <title>Stashd</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{--bg:#000;--card:#0a0a0a;--card2:#141414;--border:#1c1c1c;--text:#fff;--text2:#666;--text3:#444;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--orange:#f97316;--purple:#a855f7;--pink:#ec4899;--yellow:#eab308;--cyan:#06b6d4}
        html,body{height:100%;font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;font-size:15px}
        .app{height:100%;max-width:430px;margin:0 auto;display:flex;flex-direction:column}
        .screen{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:90px}.screen.hidden{display:none}
        .header{padding:24px 20px 16px;padding-top:max(24px,calc(env(safe-area-inset-top) + 12px))}
        .header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
        .header-title{font-size:28px;font-weight:700;letter-spacing:-0.5px}
        .header-sub{font-size:14px;color:var(--text2)}
        .header-btn{background:#fff;color:#000;border:none;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px}
        .header-btn:active{transform:scale(0.96)}
        .header-btn svg{width:18px;height:18px}
        .big-stat{text-align:center;padding:20px}
        .big-stat-label{font-size:13px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
        .big-stat-value{font-size:48px;font-weight:700;letter-spacing:-2px}
        .big-stat-sub{font-size:14px;color:var(--text2);margin-top:4px}
        .stats-row{display:flex;gap:10px;padding:0 16px 20px;overflow-x:auto;scroll-snap-type:x mandatory}.stats-row::-webkit-scrollbar{display:none}
        .stat-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;text-align:center;cursor:pointer;min-width:90px;flex-shrink:0;scroll-snap-align:start}
        .stat-card:active{background:var(--card2)}
        .stat-icon{font-size:20px;margin-bottom:6px}
        .stat-num{font-size:18px;font-weight:700}
        .stat-label{font-size:10px;color:var(--text2);text-transform:uppercase;margin-top:2px}
        .analytics{background:var(--card);border:1px solid var(--border);border-radius:16px;margin:0 16px 20px;overflow:hidden}
        .analytics-header{padding:16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);cursor:pointer}
        .analytics-title{font-size:15px;font-weight:600}
        .analytics-toggle{color:var(--text2);font-size:13px;display:flex;align-items:center;gap:6px}
        .analytics-toggle svg{width:16px;height:16px;transition:transform 0.2s}
        .analytics.expanded .analytics-toggle svg{transform:rotate(180deg)}
        .analytics-body{display:none}.analytics.expanded .analytics-body{display:block}
        .period-tabs{display:flex;padding:12px 16px;gap:8px;border-bottom:1px solid var(--border)}
        .period-tab{flex:1;padding:10px;border-radius:10px;text-align:center;font-size:13px;font-weight:500;color:var(--text2);cursor:pointer;background:var(--card2)}
        .period-tab.active{background:#fff;color:#000}
        .analytics-total{padding:20px 16px;text-align:center;border-bottom:1px solid var(--border)}
        .analytics-total-label{font-size:12px;color:var(--text2);margin-bottom:4px}
        .analytics-total-value{font-size:32px;font-weight:700}
        .analytics-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px 16px;border-bottom:1px solid var(--border)}
        .mini-stat{text-align:center;padding:8px}
        .mini-stat-value{display:block;font-size:18px;font-weight:700;color:var(--text)}
        .mini-stat-label{font-size:10px;color:var(--text2);text-transform:uppercase}
        .analytics-section{padding:12px 16px;border-bottom:1px solid var(--border)}
        .analytics-section:last-child{border-bottom:none}
        .analytics-section-title{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px}
        .merchant-item{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
        .merchant-item:last-child{border-bottom:none}
        .merchant-name{font-size:14px;font-weight:500}
        .merchant-count{font-size:11px;color:var(--text2)}
        .merchant-total{font-size:14px;font-weight:600;color:var(--green)}
        .daily-item{display:flex;align-items:center;gap:12px;padding:6px 0}
        .daily-date{font-size:12px;color:var(--text2);width:60px}
        .daily-bar{flex:1;height:8px;background:var(--card2);border-radius:4px;overflow:hidden}
        .daily-fill{height:100%;background:var(--green);border-radius:4px}
        .daily-amount{font-size:12px;font-weight:600;width:70px;text-align:right}
        .category-list{padding:8px 0}
        .category-item{display:flex;align-items:center;padding:12px 16px;gap:12px}
        .category-icon{font-size:20px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--card2);border-radius:10px}
        .category-info{flex:1}
        .category-name{font-size:14px;font-weight:500}
        .category-bar{height:4px;background:var(--card2);border-radius:2px;margin-top:6px;overflow:hidden}
        .category-fill{height:100%;border-radius:2px}
        .category-value{font-size:14px;font-weight:600}
        .category-count{font-size:11px;color:var(--text2)}
        .section-header{display:flex;align-items:center;justify-content:space-between;padding:0 20px 12px}
        .section-title{font-size:13px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
        .section-action{font-size:13px;color:var(--blue);cursor:pointer}
        .item-list{padding:0 16px}
        .list-item{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:14px;cursor:pointer}
        .list-item:active{transform:scale(0.98);background:var(--card2)}
        .list-thumb{width:52px;height:52px;border-radius:10px;object-fit:cover;background:var(--card2)}
        .list-content{flex:1;min-width:0}
        .list-title{font-weight:600;font-size:15px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .list-sub{font-size:13px;color:var(--text2);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .list-tag{display:inline-flex;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:500}
        .list-amount{font-weight:600;font-size:15px;color:var(--green)}
        .list-dupe{background:var(--orange);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600}
        .search-box{background:var(--card2);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin:0 16px 16px;display:flex;align-items:center;gap:12px}
        .search-box svg{width:18px;height:18px;color:var(--text3)}
        .search-box input{flex:1;background:none;border:none;color:var(--text);font-size:15px;outline:none}
        .search-box input::placeholder{color:var(--text3)}
        .filters{display:flex;gap:8px;padding:0 16px 16px;overflow-x:auto}.filters::-webkit-scrollbar{display:none}
        .filter{background:var(--card2);border:1px solid var(--border);border-radius:100px;padding:10px 16px;font-size:13px;font-weight:500;color:var(--text2);white-space:nowrap;cursor:pointer}
        .filter:active{transform:scale(0.95)}
        .filter.active{background:#fff;color:#000;border-color:#fff}
        .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:3px;padding:0 3px}
        .grid-item{position:relative;aspect-ratio:1;overflow:hidden;background:var(--card);cursor:pointer}
        .grid-item img{width:100%;height:100%;object-fit:cover}
        .grid-overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.85) 0%,transparent 60%);padding:12px;display:flex;flex-direction:column;justify-content:flex-end}
        .grid-type{display:inline-flex;align-items:center;gap:5px;background:rgba(0,0,0,0.6);backdrop-filter:blur(10px);padding:5px 8px;border-radius:6px;font-size:10px;font-weight:600;width:fit-content;margin-bottom:6px}
        .grid-title{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .grid-meta{display:flex;justify-content:space-between;align-items:center;margin-top:2px}
        .grid-amount{font-size:12px;font-weight:600;color:var(--green)}
        .grid-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
        .grid-tag{background:rgba(59,130,246,0.3);padding:2px 6px;border-radius:4px;font-size:9px;color:#93c5fd}
        .grid-time{font-size:10px;color:rgba(255,255,255,0.5)}
        .grid-dupe{position:absolute;top:8px;left:8px;background:var(--orange);padding:4px 8px;border-radius:6px;font-size:10px;font-weight:600}
        .map-container{height:280px;background:var(--card);border:1px solid var(--border);border-radius:16px;margin:0 16px 16px;overflow:hidden}
        #map{width:100%;height:100%;background:#1a1a2e}
        .place-list{padding:0 16px}
        .place-item{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:14px;cursor:pointer}
        .place-item:active{transform:scale(0.98)}
        .place-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
        .place-content{flex:1}
        .place-name{font-weight:600;font-size:15px}
        .place-address{font-size:13px;color:var(--text2);margin-top:2px}
        .settings-group{background:var(--card);border:1px solid var(--border);border-radius:16px;margin:0 16px 16px;overflow:hidden}
        .settings-item{display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
        .settings-item:not(:last-child){border-bottom:1px solid var(--border)}
        .settings-left{display:flex;align-items:center;gap:14px}
        .settings-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .settings-icon svg{width:18px;height:18px}
        .settings-label{font-size:15px}
        .settings-desc{font-size:12px;color:var(--text2);margin-top:2px}
        .settings-value{font-size:15px;color:var(--text2);cursor:pointer}
        .settings-input{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:14px;width:100px;text-align:right}
        .settings-input:focus{outline:none;border-color:var(--blue)}
        .toggle{width:52px;height:32px;background:var(--card2);border:1px solid var(--border);border-radius:16px;position:relative;cursor:pointer;flex-shrink:0}
        .toggle.on{background:var(--green);border-color:var(--green)}
        .toggle::after{content:'';position:absolute;width:26px;height:26px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform 0.2s}
        .toggle.on::after{transform:translateX(20px)}
        .tabs{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(30px);border-top:1px solid var(--border);padding:8px 20px;padding-bottom:max(8px,env(safe-area-inset-bottom));display:flex;justify-content:center}
        .tabs-inner{display:flex;max-width:430px;width:100%;justify-content:space-around}
        .tab{display:flex;flex-direction:column;align-items:center;padding:8px 12px;cursor:pointer;border-radius:12px}
        .tab:active{background:rgba(255,255,255,0.05)}
        .tab svg{width:24px;height:24px;color:var(--text3);stroke-width:1.8;margin-bottom:4px}
        .tab span{font-size:10px;font-weight:500;color:var(--text3)}
        .tab.active svg{color:var(--text)}.tab.active span{color:var(--text)}
        .toast{position:fixed;bottom:110px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--card);border:1px solid var(--border);padding:14px 24px;border-radius:14px;font-size:14px;font-weight:500;opacity:0;transition:all 0.3s;z-index:999;display:flex;align-items:center;gap:10px;max-width:90%}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:1000;display:none;flex-direction:column}
        .modal.show{display:flex}
        .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;padding-top:max(16px,env(safe-area-inset-top))}
        .modal-close,.modal-delete{width:36px;height:36px;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}
        .modal-close{background:rgba(255,255,255,0.1);color:#fff}
        .modal-close svg,.modal-delete svg{width:18px;height:18px}
        .modal-delete{background:rgba(239,68,68,0.2);color:var(--red)}
        .modal-img{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;min-height:0}
        .modal-img img{max-width:100%;max-height:100%;object-fit:contain;border-radius:12px}
        .modal-info{background:var(--card);border-top:1px solid var(--border);padding:20px;padding-bottom:max(20px,env(safe-area-inset-bottom))}
        .modal-type{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:10px;font-size:13px;font-weight:600;margin-bottom:12px}
        .modal-title-row{display:flex;align-items:center;gap:10px;margin-bottom:4px}
        .modal-title{font-size:20px;font-weight:700;flex:1}
        .modal-edit{width:32px;height:32px;background:var(--card2);border:none;border-radius:8px;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center}
        .modal-edit svg{width:16px;height:16px}
        .modal-subtitle{color:var(--text2);margin-bottom:16px}
        .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
        .modal-btn{flex:1;min-width:calc(50% - 5px);background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:14px;color:var(--text);font-size:14px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
        .modal-btn svg{width:18px;height:18px}
        .modal-btn.primary{background:#fff;color:#000;border-color:#fff}
        .modal-btn.blue{background:var(--blue);border-color:var(--blue)}
        .modal-btn.orange{background:var(--orange);border-color:var(--orange)}
        .edit-modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:1001;display:none;align-items:center;justify-content:center;padding:20px}
        .edit-modal.show{display:flex}
        .edit-box{background:var(--card);border:1px solid var(--border);border-radius:20px;width:100%;max-width:360px;padding:24px}
        .edit-title{font-size:18px;font-weight:600;margin-bottom:20px}
        .edit-field{margin-bottom:16px}
        .edit-label{font-size:13px;color:var(--text2);margin-bottom:8px}
        .edit-input{width:100%;background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;color:var(--text);font-size:16px}
        .edit-input:focus{outline:none;border-color:var(--blue)}
        .edit-actions{display:flex;gap:10px;margin-top:20px}
        .edit-btn{flex:1;padding:14px;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;border:none}
        .edit-btn.cancel{background:var(--card2);color:var(--text)}
        .edit-btn.save{background:#fff;color:#000}
        .export-modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:1001;display:none;align-items:center;justify-content:center;padding:20px}
        .export-modal.show{display:flex}
        .export-box{background:var(--card);border:1px solid var(--border);border-radius:20px;width:100%;max-width:360px;padding:24px}
        .export-title{font-size:18px;font-weight:600;margin-bottom:20px}
        .export-options{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
        .export-option{display:flex;align-items:center;gap:12px;padding:14px;background:var(--card2);border:1px solid var(--border);border-radius:12px;cursor:pointer}
        .export-option.selected{border-color:var(--green);background:rgba(34,197,94,0.1)}
        .export-checkbox{width:22px;height:22px;border:2px solid var(--border);border-radius:6px;display:flex;align-items:center;justify-content:center}
        .export-option.selected .export-checkbox{background:var(--green);border-color:var(--green)}
        .export-option.selected .export-checkbox::after{content:'‚úì';color:#fff;font-size:14px}
        .export-option-text{flex:1;font-size:15px}
        .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 40px;text-align:center}
        .empty-title{font-size:20px;font-weight:600;margin-bottom:8px}
        .empty-text{color:var(--text2);font-size:15px;margin-bottom:24px;max-width:260px}
        .progress-bar{position:fixed;top:0;left:0;right:0;height:3px;background:var(--card2);z-index:2000;display:none}
        .progress-bar.show{display:block}
        .progress-fill{height:100%;background:var(--orange);transition:width 0.3s}
        .progress-text{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border:1px solid var(--border);padding:20px 32px;border-radius:16px;font-size:15px;font-weight:600;z-index:2001;display:none;text-align:center}
        .progress-text.show{display:block}
        .progress-text .pct{font-size:28px;font-weight:700;color:var(--orange);display:block;margin-top:8px}
        #file-input,#import-input{display:none}
        .leaflet-container{background:#1a1a2e!important}
        .custom-marker{background:var(--orange);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    </style>
</head>
<body>
    <div class="app">
        <div class="progress-bar" id="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <div class="progress-text" id="progress-text">Processing...<span class="pct" id="progress-pct">0%</span></div>
        
        <div class="screen" id="home">
            <div class="header">
                <div class="header-row">
                    <h1 class="header-title" style="display:flex;align-items:center;gap:10px"><span style="background:var(--orange);width:24px;height:24px;border-radius:5px"></span><span style="color:var(--orange);font-weight:800;font-size:26px;letter-spacing:-0.5px">STASH'D</span></h1>
                    <button class="header-btn" onclick="pickFiles()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        Add
                    </button>
                </div>
                <p class="header-sub">Your screenshot stash</p>
            </div>
            
            <div class="big-stat">
                <div class="big-stat-label">Total Tracked</div>
                <div class="big-stat-value" id="home-total">$0.00</div>
                <div class="big-stat-sub" id="home-count">0 items</div>
            </div>
            
            <div class="stats-row" id="stats-row">
                <!-- Dynamically populated and sorted by count -->
            </div>
            
            <div class="analytics expanded" id="analytics">
                <div class="analytics-header" onclick="toggleAnalytics()">
                    <span class="analytics-title">üìä Spending Analytics</span>
                    <span class="analytics-toggle">Collapse <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                </div>
                <div class="analytics-body">
                    <div class="period-tabs">
                        <div class="period-tab active" onclick="setPeriod('week',this)">Week</div>
                        <div class="period-tab" onclick="setPeriod('month',this)">Month</div>
                        <div class="period-tab" onclick="setPeriod('all',this)">All</div>
                    </div>
                    <div class="analytics-total">
                        <div class="analytics-total-label" id="period-label">This Week</div>
                        <div class="analytics-total-value" id="period-total">$0.00</div>
                    </div>
                    
                    <!-- Quick Stats Row -->
                    <div class="analytics-stats" id="analytics-stats">
                        <div class="mini-stat"><span class="mini-stat-value" id="stat-txns">0</span><span class="mini-stat-label">Transactions</span></div>
                        <div class="mini-stat"><span class="mini-stat-value" id="stat-avg">$0</span><span class="mini-stat-label">Average</span></div>
                        <div class="mini-stat"><span class="mini-stat-value" id="stat-largest">$0</span><span class="mini-stat-label">Largest</span></div>
                    </div>
                    
                    <!-- Top Merchants -->
                    <div class="analytics-section">
                        <div class="analytics-section-title">üè™ Top Merchants</div>
                        <div id="top-merchants"></div>
                    </div>
                    
                    <!-- Category Breakdown -->
                    <div class="analytics-section">
                        <div class="analytics-section-title">üìÇ By Category</div>
                        <div class="category-list" id="category-breakdown"></div>
                    </div>
                    
                    <!-- Daily Breakdown -->
                    <div class="analytics-section">
                        <div class="analytics-section-title">üìÖ Daily Spending</div>
                        <div id="daily-breakdown"></div>
                    </div>
                </div>
            </div>
            
            <div class="section-header"><span class="section-title">Recent</span><span class="section-action" onclick="switchTab('browse')">See All</span></div>
            <div class="item-list" id="home-recent"></div>
        </div>
        
        <div class="screen hidden" id="browse">
            <div class="header"><h1 class="header-title">Browse</h1></div>
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" placeholder="Search..." id="search" oninput="render()">
            </div>
            <div class="filters" id="filters"></div>
            <div id="browse-content"></div>
        </div>
        
        <div class="screen hidden" id="places">
            <div class="header"><h1 class="header-title">Places</h1><p class="header-sub">Saved locations</p></div>
            <div class="map-container"><div id="map"></div></div>
            <div class="filters" style="padding-top:0"><div class="filter active" data-filter="all">All</div><div class="filter" data-filter="food">üçú Food</div><div class="filter" data-filter="cafe">‚òï Cafes</div><div class="filter" data-filter="travel">‚úàÔ∏è Travel</div></div>
            <div class="place-list" id="places-list"></div>
        </div>
        
        <div class="screen hidden" id="settings">
            <div class="header"><h1 class="header-title">Settings</h1></div>
            <div class="section-header"><span class="section-title">AI</span></div>
            <div class="settings-group">
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--purple)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/></svg></div><div><div class="settings-label">OpenAI API Key</div><div class="settings-desc">For smart classification</div></div></div><input type="password" class="settings-input" id="api-key" placeholder="sk-..." oninput="saveApiKey()" style="width:90px"></div>
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--green)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg></div><span class="settings-label">Use AI</span></div><div class="toggle" id="use-ai-toggle" onclick="toggleAI()"></div></div>
            </div>
            <div class="section-header"><span class="section-title">Features</span></div>
            <div class="settings-group">
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--cyan)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg></div><div><div class="settings-label">Duplicate Detection</div></div></div><div class="toggle on" id="dupe-toggle" onclick="this.classList.toggle('on');saveSettings()"></div></div>
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--blue)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg></div><div><div class="settings-label">Compress Images</div><div class="settings-desc">~50% smaller files</div></div></div><div class="toggle on" id="compress-toggle" onclick="this.classList.toggle('on');saveSettings()"></div></div>
            </div>
            <div class="section-header"><span class="section-title">Currency</span></div>
            <div class="settings-group">
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--yellow)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><span class="settings-label">Currency</span></div><select class="settings-input" id="base-currency" onchange="saveSettings()" style="width:80px"><option value="USD">USD</option><option value="THB">THB</option><option value="EUR">EUR</option></select></div>
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--cyan)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></div><span class="settings-label">THB Rate</span></div><input type="number" class="settings-input" id="exchange-rate" value="35.5" step="0.1" style="width:80px" oninput="saveSettings()"></div>
            </div>
            <div class="section-header"><span class="section-title">Export</span></div>
            <div class="settings-group">
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--red)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg></div><div><div class="settings-label">Export PDF Report</div><div class="settings-desc">Choose what to include</div></div></div><span class="settings-value" onclick="openExportModal()">Export ‚Üí</span></div>
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--blue)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="m17 8-5-5-5 5"/><path d="M12 3v12"/></svg></div><div><div class="settings-label">Full Backup</div></div></div><span class="settings-value" onclick="exportFull()">Export ‚Üí</span></div>
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--green)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="m7 10 5 5 5-5"/><path d="M12 15V3"/></svg></div><div><div class="settings-label">Import Backup</div></div></div><span class="settings-value" onclick="importBackup()">Import ‚Üí</span></div>
            </div>
            <div class="section-header"><span class="section-title">Data</span></div>
            <div class="settings-group">
                <div class="settings-item"><span class="settings-label">Storage</span><span class="settings-value" id="storage-used">0 MB</span></div>
                <div class="settings-item"><div class="settings-left"><div class="settings-icon" style="background:var(--red)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></div><span class="settings-label">Clear All</span></div><span class="settings-value" onclick="clearData()">Clear ‚Üí</span></div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tabs-inner">
                <div class="tab active" data-tab="home"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg><span>Home</span></div>
                <div class="tab" data-tab="browse"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg><span>Browse</span></div>
                <div class="tab" data-tab="places"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Places</span></div>
                <div class="tab" data-tab="settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.79 1 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Settings</span></div>
            </div>
        </div>
        
        <div class="modal" id="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                <button class="modal-delete" onclick="deleteCurrentItem()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
            </div>
            <div class="modal-img"><img id="modal-image" src=""></div>
            <div class="modal-info">
                <div class="modal-type" id="modal-type"></div>
                <div class="modal-title-row"><div class="modal-title" id="modal-title"></div><button class="modal-edit" onclick="openEditModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button></div>
                <div class="modal-subtitle" id="modal-subtitle"></div>
                <div class="modal-actions" id="modal-actions"></div>
            </div>
        </div>
        
        <div class="edit-modal" id="edit-modal">
            <div class="edit-box">
                <div class="edit-title">Edit Item</div>
                <div class="edit-field"><div class="edit-label">Title</div><input type="text" class="edit-input" id="edit-title"></div>
                <div class="edit-field"><div class="edit-label">Amount</div><input type="number" class="edit-input" id="edit-amount" placeholder="0.00"></div>
                <div class="edit-field"><div class="edit-label">Type</div><select class="edit-input" id="edit-type" style="width:100%"><option value="receipt">üßæ Receipt</option><option value="bill">üìÑ Bill</option><option value="product">üõçÔ∏è Want</option><option value="food">üçú Food</option><option value="cafe">‚òï Cafe</option><option value="place">üìç Place</option><option value="travel">‚úàÔ∏è Travel</option><option value="idea">üí° Idea</option><option value="screenshot">üì± Screenshot</option></select></div>
                <div class="edit-actions"><button class="edit-btn cancel" onclick="closeEditModal()">Cancel</button><button class="edit-btn save" onclick="saveEdit()">Save</button></div>
            </div>
        </div>
        
        <div class="export-modal" id="export-modal">
            <div class="export-box">
                <div class="export-title">Export PDF Report</div>
                <div class="export-options" style="max-height:300px;overflow-y:auto">
                    <div class="export-option selected" data-type="receipt" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">üßæ Receipts</div></div>
                    <div class="export-option selected" data-type="bill" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">üìÑ Bills</div></div>
                    <div class="export-option" data-type="product" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">üõçÔ∏è Wants/Products</div></div>
                    <div class="export-option" data-type="food" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">üçú Food</div></div>
                    <div class="export-option" data-type="cafe" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">‚òï Cafes</div></div>
                    <div class="export-option" data-type="place" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">üìç Places</div></div>
                    <div class="export-option" data-type="travel" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">‚úàÔ∏è Travel</div></div>
                    <div class="export-option" data-type="transfer" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">üí∏ Transfers</div></div>
                    <div class="export-option" data-type="idea" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">üí° Ideas</div></div>
                    <div class="export-option" data-type="screenshot" onclick="toggleExportOption(this)"><div class="export-checkbox"></div><div class="export-option-text">üì± Screenshots</div></div>
                    <div class="export-option" data-type="all" onclick="toggleExportOption(this)" style="border-color:var(--orange)"><div class="export-checkbox"></div><div class="export-option-text">üî• Everything</div></div>
                </div>
                <div class="edit-actions"><button class="edit-btn cancel" onclick="closeExportModal()">Cancel</button><button class="edit-btn save" onclick="generatePDF()">Generate PDF</button></div>
            </div>
        </div>
        
        <div class="toast" id="toast"></div>
    </div>
    
    <input type="file" id="file-input" accept="image/*" multiple>
    <input type="file" id="import-input" accept=".json">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let items=JSON.parse(localStorage.getItem('stashd_items')||'[]');
let activeFilter='all',currentItemId=null,currentPeriod='week',map=null,markers=[];
let settings=JSON.parse(localStorage.getItem('stashd_settings')||'{}');
settings.exchangeRate=settings.exchangeRate||35.5;
settings.baseCurrency=settings.baseCurrency||'USD';
settings.useAI=settings.useAI||false;
settings.duplicateDetection=settings.duplicateDetection!==false;
settings.compress=settings.compress!==false;

const TYPES={receipt:{icon:'üßæ',label:'Receipt',color:'#22c55e'},bill:{icon:'üìÑ',label:'Bill',color:'#ef4444'},product:{icon:'üõçÔ∏è',label:'Want',color:'#f97316'},food:{icon:'üçú',label:'Food',color:'#ec4899'},cafe:{icon:'‚òï',label:'Cafe',color:'#8b5cf6'},place:{icon:'üìç',label:'Place',color:'#3b82f6'},travel:{icon:'‚úàÔ∏è',label:'Travel',color:'#06b6d4'},transfer:{icon:'üí∏',label:'Transfer',color:'#a855f7'},idea:{icon:'üí°',label:'Idea',color:'#eab308'},screenshot:{icon:'üì±',label:'Screenshot',color:'#6b7280'}};
const PLACE_TYPES=['food','cafe','place','travel'];
const CATEGORIES=[{id:'food',name:'Food',icon:'üçú',color:'#ec4899'},{id:'shopping',name:'Shopping',icon:'üõçÔ∏è',color:'#f97316'},{id:'transport',name:'Transport',icon:'üöó',color:'#22c55e'},{id:'utilities',name:'Utilities',icon:'üí°',color:'#eab308'},{id:'other',name:'Other',icon:'üì¶',color:'#6b7280'}];

// Mock coordinates for demo
const MOCK_COORDS={food:[13.7563,100.5018],cafe:[13.7465,100.5392],place:[13.7469,100.5349],travel:[7.8804,98.3923]};

if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});

async function compressImage(dataUrl,maxWidth=600,quality=0.5){
    return new Promise(resolve=>{
        const img=new Image();
        img.onload=()=>{
            const canvas=document.createElement('canvas');
            let w=img.width,h=img.height;
            if(w>maxWidth){h=h*(maxWidth/w);w=maxWidth;}
            canvas.width=w;canvas.height=h;
            canvas.getContext('2d').drawImage(img,0,0,w,h);
            resolve(canvas.toDataURL('image/jpeg',quality));
        };
        img.onerror=()=>resolve(dataUrl);
        img.src=dataUrl;
    });
}

function imageHash(dataUrl){let hash=0;const s=dataUrl.slice(-500);for(let i=0;i<s.length;i++){hash=((hash<<5)-hash)+s.charCodeAt(i);hash|=0;}return hash.toString(36);}
function findDuplicate(hash){return settings.duplicateDetection?items.find(i=>i.hash===hash):null;}
function convertCurrency(amount,from){const rate=parseFloat(settings.exchangeRate)||35.5;if(from==='THB'&&settings.baseCurrency==='USD')return amount/rate;if(from==='USD'&&settings.baseCurrency==='THB')return amount*rate;return amount;}
function formatCurrency(amount,currency){const symbols={USD:'$',THB:'‡∏ø',EUR:'‚Ç¨'};return(symbols[currency]||'')+amount.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

// Smart Tags for better AI suggestions
const SMART_TAGS={
    receipt:['expense','tax-deductible','reimbursable','personal','business'],
    bill:['utility','monthly','overdue','autopay','subscription'],
    product:['wishlist','compare','buy-later','gift-idea','sale'],
    food:['favorite','try-again','delivery','dine-in','cheap-eats'],
    cafe:['workspace','meeting-spot','wifi','quiet','aesthetic'],
    place:['must-visit','been-here','bookmark','recommend','hidden-gem'],
    travel:['bucket-list','booked','research','deal','adventure'],
    transfer:['income','expense','split','refund','recurring'],
    idea:['urgent','someday','project','side-hustle','content'],
    screenshot:['reference','save','share','temp','important']
};

// Real AI Classification using OpenAI Vision API
async function classifyWithAI(imageBase64){
    const apiKey=localStorage.getItem('stashd_apikey');
    if(!apiKey){
        return{type:'screenshot',title:'Add API Key for AI',amount:null,currency:'THB',location:null,category:'other',smartTags:['needs-ai'],confidence:0};
    }
    
    try{
        const response=await fetch('https://api.openai.com/v1/chat/completions',{
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},
            body:JSON.stringify({
                model:'gpt-4o-mini',
                messages:[{
                    role:'user',
                    content:[
                        {type:'text',text:`Analyze this image and return JSON only (no markdown):
{
  "type": "receipt|bill|product|food|cafe|place|travel|transfer|idea|screenshot",
  "title": "specific name/merchant/item",
  "amount": number or null,
  "currency": "THB|USD|EUR",
  "category": "food|shopping|utilities|travel|entertainment|transport|health|subscriptions|other",
  "location": {"name":"place name"} or null,
  "smartTags": ["tag1","tag2","tag3"],
  "confidence": 0.0-1.0
}
Rules:
- type: receipt=purchase receipt, bill=utility/invoice, product=item for sale/wishlist, food=restaurant/delivery, cafe=coffee shop, place=location/attraction, travel=booking/ticket, transfer=bank/payment, idea=note/inspiration, screenshot=other
- title: Be specific (e.g. "Starbucks Siam Paragon" not just "Coffee")
- amount: Extract exact number if visible, null if not
- smartTags: 2-4 relevant tags based on actual content
- Only include location if it's a physical place
- If unclear, use type:screenshot with descriptive title`},
                        {type:'image_url',image_url:{url:imageBase64,detail:'low'}}
                    ]
                }],
                max_tokens:300
            })
        });
        
        const data=await response.json();
        if(data.error){
            console.error('OpenAI error:',data.error);
            return fallbackClassify();
        }
        
        const text=data.choices?.[0]?.message?.content||'';
        // Parse JSON from response (handle potential markdown wrapping)
        const jsonMatch=text.match(/\{[\s\S]*\}/);
        if(jsonMatch){
            const parsed=JSON.parse(jsonMatch[0]);
            return{
                type:parsed.type||'screenshot',
                title:parsed.title||'Untitled',
                amount:parsed.amount,
                currency:parsed.currency||'THB',
                location:parsed.location,
                category:parsed.category||'other',
                smartTags:parsed.smartTags||[],
                confidence:parsed.confidence||0.8
            };
        }
        return fallbackClassify();
    }catch(err){
        console.error('AI classification failed:',err);
        return fallbackClassify();
    }
}

// Basic fallback when no API key - NO fake data
function fallbackClassify(){
    return{type:'screenshot',title:'Screenshot',amount:null,currency:null,location:null,category:null,smartTags:[],confidence:0,noAI:true};
}

async function processImage(dataUrl){
    // Always compress to save storage space
    dataUrl=await compressImage(dataUrl);
    const hash=imageHash(dataUrl);
    const dupe=findDuplicate(hash);
    
    // Use real AI if available
    const c=settings.useAI?await classifyWithAI(dataUrl):fallbackClassify();
    const type=TYPES[c.type]||TYPES.screenshot;
    
    // Add coordinates if location exists but has no lat/lng (default to Bangkok area)
    let location=c.location;
    if(location&&location.name&&(!location.lat||!location.lng)){
        location={
            ...location,
            lat:13.7563+(Math.random()-0.5)*0.1,
            lng:100.5018+(Math.random()-0.5)*0.1
        };
    }
    
    return{
        id:Date.now()+Math.random(),
        uri:dataUrl,
        hash,
        time:Date.now(),
        typeId:c.type,
        type,
        title:c.noAI?'Screenshot':c.title,
        amountOriginal:c.amount,
        currencyOriginal:c.currency,
        amountConverted:c.amount&&c.currency?convertCurrency(c.amount,c.currency):null,
        location,
        category:c.category,
        isDuplicate:!!dupe,
        smartTags:c.smartTags||[],
        confidence:c.confidence||0,
        noAI:c.noAI||false
    };
}

function showProgress(current,total){
    const bar=document.getElementById('progress-bar');
    const fill=document.getElementById('progress-fill');
    const text=document.getElementById('progress-text');
    const pct=document.getElementById('progress-pct');
    if(current>=total){
        bar.classList.remove('show');
        text.classList.remove('show');
        return;
    }
    const percent=Math.round((current/total)*100);
    bar.classList.add('show');
    text.classList.add('show');
    fill.style.width=percent+'%';
    pct.textContent=percent+'%';
}

function pickFiles(){document.getElementById('file-input').click();}
function toast(msg){const t=document.getElementById('toast');t.textContent='‚úì '+msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function switchTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add('active');document.getElementById(tab)?.classList.remove('hidden');if(tab==='places')setTimeout(initMap,100);}
function timeAgo(d){const m=Math.floor((Date.now()-d)/60000);if(m<1)return'now';if(m<60)return m+'m';if(m<1440)return Math.floor(m/60)+'h';return Math.floor(m/1440)+'d';}
function toggleAnalytics(){document.getElementById('analytics').classList.toggle('expanded');}
function setPeriod(p,el){currentPeriod=p;document.querySelectorAll('.period-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderAnalytics();}

function initMap(){
    if(map)return;
    map=L.map('map',{zoomControl:false}).setView([13.7563,100.5018],11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
        attribution:'¬©OpenStreetMap',
        maxZoom:18,
        errorTileUrl:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII='
    }).addTo(map);
    setTimeout(()=>map.invalidateSize(),200);
    renderMapPins();
}

function renderMapPins(){
    if(!map)return;
    markers.forEach(m=>map.removeLayer(m));
    markers=[];
    const places=items.filter(i=>i.location?.lat&&i.location?.lng);
    if(!places.length)return;
    
    const bounds=[];
    places.forEach(i=>{
        const icon=L.divIcon({className:'',html:`<div class="custom-marker" style="background:${i.type?.color||'#f97316'}">${i.type?.icon||'üìç'}</div>`,iconSize:[32,32],iconAnchor:[16,16]});
        const marker=L.marker([i.location.lat,i.location.lng],{icon}).addTo(map);
        marker.bindPopup(`<b>${i.title||'Place'}</b><br>${i.location.name||''}`);
        markers.push(marker);
        bounds.push([i.location.lat,i.location.lng]);
    });
    if(bounds.length>1)map.fitBounds(bounds,{padding:[30,30]});
    else if(bounds.length===1)map.setView(bounds[0],12);
}

function renderAnalytics(){
    const now=Date.now(),week=7*24*60*60*1000,month=30*24*60*60*1000;
    let filtered=items.filter(i=>i.amountConverted);
    if(currentPeriod==='week')filtered=filtered.filter(i=>now-i.time<week);
    else if(currentPeriod==='month')filtered=filtered.filter(i=>now-i.time<month);
    
    const total=filtered.reduce((s,i)=>s+i.amountConverted,0);
    const avg=filtered.length?total/filtered.length:0;
    const largest=filtered.length?Math.max(...filtered.map(i=>i.amountConverted)):0;
    
    // Update totals
    document.getElementById('period-label').textContent={week:'This Week',month:'This Month',all:'All Time'}[currentPeriod];
    document.getElementById('period-total').textContent=formatCurrency(total,settings.baseCurrency);
    
    // Quick stats
    document.getElementById('stat-txns').textContent=filtered.length;
    document.getElementById('stat-avg').textContent=formatCurrency(avg,settings.baseCurrency);
    document.getElementById('stat-largest').textContent=formatCurrency(largest,settings.baseCurrency);
    
    // Top merchants
    const merchants={};
    filtered.forEach(i=>{
        const name=i.title||'Unknown';
        if(!merchants[name])merchants[name]={count:0,total:0};
        merchants[name].count++;
        merchants[name].total+=i.amountConverted;
    });
    const topMerchants=Object.entries(merchants).sort((a,b)=>b[1].total-a[1].total).slice(0,5);
    document.getElementById('top-merchants').innerHTML=topMerchants.length?topMerchants.map(([name,data])=>
        `<div class="merchant-item"><div><div class="merchant-name">${name}</div><div class="merchant-count">${data.count} transaction${data.count>1?'s':''}</div></div><div class="merchant-total">${formatCurrency(data.total,settings.baseCurrency)}</div></div>`
    ).join(''):'<div style="padding:12px;text-align:center;color:var(--text2);font-size:13px">No transactions yet</div>';
    
    // Category breakdown
    const catTotals={};
    filtered.forEach(i=>{catTotals[i.category||'other']=(catTotals[i.category||'other']||0)+i.amountConverted;});
    const maxCat=Math.max(...Object.values(catTotals),1);
    document.getElementById('category-breakdown').innerHTML=CATEGORIES.filter(c=>catTotals[c.id]).map(c=>
        `<div class="category-item"><div class="category-icon">${c.icon}</div><div class="category-info"><div class="category-name">${c.name}</div><div class="category-bar"><div class="category-fill" style="width:${(catTotals[c.id]/maxCat)*100}%;background:${c.color}"></div></div></div><div style="text-align:right"><div class="category-value">${formatCurrency(catTotals[c.id],settings.baseCurrency)}</div><div class="category-count">${filtered.filter(i=>i.category===c.id).length}</div></div></div>`
    ).join('')||'<div style="padding:12px;text-align:center;color:var(--text2);font-size:13px">No categories</div>';
    
    // Daily breakdown (last 7 days)
    const days={};
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    for(let d=0;d<7;d++){
        const date=new Date(now-d*24*60*60*1000);
        const key=date.toDateString();
        days[key]={label:d===0?'Today':d===1?'Yesterday':dayNames[date.getDay()],total:0};
    }
    filtered.forEach(i=>{
        const key=new Date(i.time).toDateString();
        if(days[key])days[key].total+=i.amountConverted;
    });
    const maxDay=Math.max(...Object.values(days).map(d=>d.total),1);
    document.getElementById('daily-breakdown').innerHTML=Object.entries(days).map(([key,data])=>
        `<div class="daily-item"><span class="daily-date">${data.label}</span><div class="daily-bar"><div class="daily-fill" style="width:${(data.total/maxDay)*100}%"></div></div><span class="daily-amount">${formatCurrency(data.total,settings.baseCurrency)}</span></div>`
    ).join('');
}

function openModal(itemId){
    const item=items.find(i=>i.id===itemId);if(!item)return;currentItemId=itemId;
    document.getElementById('modal-image').src=item.uri;
    document.getElementById('modal-type').innerHTML=`${item.type?.icon||'üì±'} ${item.type?.label||'Item'}`;
    document.getElementById('modal-type').style.background=(item.type?.color||'#666')+'30';
    document.getElementById('modal-type').style.color=item.type?.color||'#666';
    document.getElementById('modal-title').textContent=item.title||'Untitled';
    document.getElementById('modal-subtitle').textContent=item.location?.name||(item.amountOriginal?formatCurrency(item.amountOriginal,item.currencyOriginal):'No value');
    let actions='';
    if(item.typeId==='product')actions+=`<button class="modal-btn blue" onclick="findSimilar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>Find</button>`;
    if(item.location)actions+=`<button class="modal-btn orange" onclick="openMaps()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/></svg>Map</button>`;
    actions+=`<button class="modal-btn" onclick="openReminder()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>Remind</button>`;
    actions+=`<button class="modal-btn primary" onclick="closeModal()">Done</button>`;
    document.getElementById('modal-actions').innerHTML=actions;
    document.getElementById('modal').classList.add('show');
}

function closeModal(){document.getElementById('modal').classList.remove('show');currentItemId=null;}
function openEditModal(){const item=items.find(i=>i.id===currentItemId);if(!item)return;document.getElementById('edit-title').value=item.title||'';document.getElementById('edit-amount').value=item.amountOriginal||'';document.getElementById('edit-type').value=item.typeId||'screenshot';document.getElementById('edit-modal').classList.add('show');}
function closeEditModal(){document.getElementById('edit-modal').classList.remove('show');}
function saveEdit(){const item=items.find(i=>i.id===currentItemId);if(!item)return;item.title=document.getElementById('edit-title').value;item.amountOriginal=parseFloat(document.getElementById('edit-amount').value)||null;item.amountConverted=item.amountOriginal?convertCurrency(item.amountOriginal,item.currencyOriginal):null;item.typeId=document.getElementById('edit-type').value;item.type=TYPES[item.typeId]||TYPES.screenshot;if(PLACE_TYPES.includes(item.typeId)&&!item.location)item.location={name:item.title,lat:13.7563+Math.random()*0.1,lng:100.5018+Math.random()*0.1};saveItems();closeEditModal();openModal(currentItemId);render();toast('Saved');}
function deleteCurrentItem(){if(!currentItemId)return;items=items.filter(i=>i.id!==currentItemId);saveItems();closeModal();render();toast('Deleted');}
function findSimilar(){window.open('https://lens.google.com/','_blank');}
function openMaps(){const item=items.find(i=>i.id===currentItemId);if(!item?.location)return;window.open(`https://www.google.com/maps/search/${encodeURIComponent(item.title)}`,'_blank');}
function openReminder(){const item=items.find(i=>i.id===currentItemId);if(!item)return;window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(item.title)}`,'_blank');}

function openExportModal(){document.getElementById('export-modal').classList.add('show');}
function closeExportModal(){document.getElementById('export-modal').classList.remove('show');}
function toggleExportOption(el){if(el.dataset.type==='all'){document.querySelectorAll('.export-option').forEach(o=>o.classList.remove('selected'));el.classList.add('selected');}else{document.querySelector('.export-option[data-type="all"]').classList.remove('selected');el.classList.toggle('selected');}}

function generatePDF(){
    const selectedTypes=Array.from(document.querySelectorAll('.export-option.selected')).map(o=>o.dataset.type);
    const includeAll=selectedTypes.includes('all');
    let filtered=includeAll?[...items]:items.filter(i=>selectedTypes.includes(i.typeId));
    const total=filtered.filter(i=>i.amountConverted).reduce((s,i)=>s+i.amountConverted,0);
    
    let html=`<!DOCTYPE html><html><head><title>Stashd Report</title><style>
        body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
        h1{color:#333;border-bottom:2px solid #f97316;padding-bottom:10px}
        .summary{background:#f5f5f5;padding:20px;border-radius:8px;margin:20px 0}
        .total{font-size:32px;font-weight:bold;color:#22c55e}
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th{background:#333;color:#fff;padding:12px;text-align:left}
        td{border-bottom:1px solid #ddd;padding:12px}
        .type-badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px}
        .amount{font-weight:bold;color:#22c55e}
    </style></head><body>
    <h1>üìä Stashd Expense Report</h1>
    <div class="summary">
        <p>Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
        <p>Items: ${filtered.length}</p>
        <p class="total">Total: ${formatCurrency(total,settings.baseCurrency)}</p>
    </div>
    <table>
        <tr><th>Date</th><th>Type</th><th>Item</th><th>Amount</th></tr>
        ${filtered.map(i=>`<tr>
            <td>${new Date(i.time).toLocaleDateString()}</td>
            <td><span class="type-badge" style="background:${i.type?.color||'#666'}30;color:${i.type?.color||'#666'}">${i.type?.icon||'üì±'} ${i.type?.label||'Item'}</span></td>
            <td><strong>${i.title||'Untitled'}</strong></td>
            <td class="amount">${formatCurrency(i.amountConverted,settings.baseCurrency)}</td>
        </tr>`).join('')}
    </table>
    <p style="margin-top:40px;color:#666;font-size:12px">Generated by Stashd</p>
    </body></html>`;
    
    const w=window.open('','_blank');
    w.document.write(html);
    w.document.close();
    setTimeout(()=>w.print(),500);
    closeExportModal();
    toast('PDF ready');
}

function exportFull(){const data=JSON.stringify({version:'3.3',exported:new Date().toISOString(),settings,items});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type:'application/json'}));a.download=`stashd-${new Date().toISOString().split('T')[0]}.json`;a.click();toast('Backup saved');}
function importBackup(){document.getElementById('import-input').click();}
document.getElementById('import-input').addEventListener('change',async e=>{const file=e.target.files[0];if(!file)return;try{const data=JSON.parse(await file.text());if(data.items){if(confirm(`Import ${data.items.length} items?`)){items=[...data.items,...items];saveItems();render();toast(`Imported ${data.items.length}`);}}}catch(err){toast('Invalid file');}e.target.value='';});
function clearData(){if(confirm('Delete all?')){items=[];saveItems();render();toast('Cleared');}}
function saveApiKey(){const key=document.getElementById('api-key').value;if(key)localStorage.setItem('stashd_apikey',key);else localStorage.removeItem('stashd_apikey');}
function toggleAI(){document.getElementById('use-ai-toggle').classList.toggle('on');settings.useAI=document.getElementById('use-ai-toggle').classList.contains('on');saveSettings();}
function saveSettings(){settings.exchangeRate=parseFloat(document.getElementById('exchange-rate').value)||35.5;settings.baseCurrency=document.getElementById('base-currency').value;settings.duplicateDetection=document.getElementById('dupe-toggle').classList.contains('on');settings.compress=document.getElementById('compress-toggle').classList.contains('on');localStorage.setItem('stashd_settings',JSON.stringify(settings));render();}
function loadSettings(){const key=localStorage.getItem('stashd_apikey');if(key)document.getElementById('api-key').value=key;document.getElementById('exchange-rate').value=settings.exchangeRate;document.getElementById('base-currency').value=settings.baseCurrency;if(settings.useAI)document.getElementById('use-ai-toggle').classList.add('on');if(!settings.duplicateDetection)document.getElementById('dupe-toggle').classList.remove('on');if(!settings.compress)document.getElementById('compress-toggle').classList.remove('on');}
function saveItems(){
    try{
        localStorage.setItem('stashd_items',JSON.stringify(items));
    }catch(e){
        console.error('Storage full!',e);
        toast('‚ö†Ô∏è Storage full! Some images may not save. Export backup recommended.');
        // Try to save without the newest item's image data
        const slimItems=items.map((item,i)=>i===0?{...item,uri:'data:image/png;base64,'}:item);
        try{localStorage.setItem('stashd_items',JSON.stringify(slimItems));}catch(e2){}
    }
}

// File upload with limit and progress
document.getElementById('file-input').addEventListener('change',async e=>{
    let files=[...e.target.files];
    if(!files.length)return;
    
    // Limit to 10 files
    if(files.length>10){
        toast('Max 10 at a time');
        files=files.slice(0,10);
    }
    
    let processed=0,dupes=0;
    for(const file of files){
        showProgress(processed,files.length);
        try{
            const dataUrl=await new Promise((resolve,reject)=>{
                const rd=new FileReader();
                rd.onload=e=>resolve(e.target.result);
                rd.onerror=reject;
                rd.readAsDataURL(file);
            });
            const item=await processImage(dataUrl);
            if(item.isDuplicate)dupes++;
            items.unshift(item);
            processed++;
            render();
            // Small delay to prevent UI freeze
            await new Promise(r=>setTimeout(r,50));
        }catch(err){
            console.error('Failed to process',err);
        }
    }
    showProgress(files.length,files.length);
    saveItems();
    toast(`${processed} added${dupes?` (${dupes} dupe${dupes>1?'s':''})`:''}`)
    e.target.value='';
});

document.querySelectorAll('.tab').forEach(t=>{t.onclick=()=>switchTab(t.dataset.tab);});
document.querySelectorAll('#places .filter').forEach(f=>{f.onclick=()=>{document.querySelectorAll('#places .filter').forEach(x=>x.classList.remove('active'));f.classList.add('active');renderPlaces(f.dataset.filter);};});

function renderPlaces(filter='all'){
    const places=items.filter(i=>i.location);
    const filtered=filter==='all'?places:places.filter(i=>i.typeId===filter);
    document.getElementById('places-list').innerHTML=filtered.length?filtered.map(i=>`<div class="place-item" onclick="openModal(${i.id})"><div class="place-icon" style="background:${i.type?.color||'#666'}30">${i.type?.icon||'üìç'}</div><div class="place-content"><div class="place-name">${i.title||'Untitled'}</div><div class="place-address">${i.location?.name||'Tap to view'}</div></div></div>`).join(''):'<div class="empty"><div class="empty-title">No places</div></div>';
    renderMapPins();
}

function render(){
    const valued=items.filter(i=>i.amountConverted);
    const total=valued.reduce((s,i)=>s+i.amountConverted,0);
    document.getElementById('home-total').textContent=formatCurrency(total,settings.baseCurrency);
    document.getElementById('home-count').textContent=`${items.length} item${items.length!==1?'s':''}`;
    // Dynamic stats row sorted by count
    const statDefs=[
        {id:'wants',icon:'üõçÔ∏è',label:'Wants',count:items.filter(i=>i.typeId==='product').length,action:"activeFilter='product';switchTab('browse');render()"},
        {id:'places',icon:'üìç',label:'Places',count:items.filter(i=>i.location).length,action:"switchTab('places')"},
        {id:'bills',icon:'üßæ',label:'Bills',count:items.filter(i=>['receipt','bill','transfer'].includes(i.typeId)).length,action:"activeFilter='receipt';switchTab('browse');render()"},
        {id:'ideas',icon:'üí°',label:'Ideas',count:items.filter(i=>i.typeId==='idea').length,action:"activeFilter='idea';switchTab('browse');render()"},
        {id:'food',icon:'üçú',label:'Food',count:items.filter(i=>['food','cafe'].includes(i.typeId)).length,action:"activeFilter='food';switchTab('browse');render()"},
        {id:'travel',icon:'‚úàÔ∏è',label:'Travel',count:items.filter(i=>i.typeId==='travel').length,action:"activeFilter='travel';switchTab('browse');render()"}
    ];
    const sortedStats=statDefs.sort((a,b)=>b.count-a.count);
    document.getElementById('stats-row').innerHTML=sortedStats.map(s=>
        `<div class="stat-card" onclick="${s.action}"><div class="stat-icon">${s.icon}</div><div class="stat-num">${s.count}</div><div class="stat-label">${s.label}</div></div>`
    ).join('');
    renderAnalytics();
    
    document.getElementById('home-recent').innerHTML=items.slice(0,5).map(i=>`<div class="list-item" onclick="openModal(${i.id})"><img src="${i.uri}" class="list-thumb"><div class="list-content"><div class="list-title">${i.noAI?'Screenshot':i.title||'Untitled'}</div><div class="list-sub">${i.noAI?`<span class="list-tag" style="background:#66666620;color:#666">üì∑ No AI</span>`:`<span class="list-tag" style="background:${i.type?.color||'#666'}20;color:${i.type?.color||'#666'}">${i.type?.icon} ${i.type?.label}</span>${i.smartTags?.slice(0,2).map(t=>`<span class="list-tag" style="background:#3b82f620;color:#3b82f6">${t}</span>`).join('')||''}`}${i.isDuplicate?'<span class="list-dupe">DUPE</span>':''}<span>${timeAgo(i.time)}</span></div></div>${!i.noAI&&i.amountConverted?`<span class="list-amount">${formatCurrency(i.amountConverted,settings.baseCurrency)}</span>`:''}</div>`).join('')||'<div class="empty"><div class="empty-title">No items</div></div>';
    
    const typeCounts={};items.forEach(i=>typeCounts[i.typeId]=(typeCounts[i.typeId]||0)+1);
    document.getElementById('filters').innerHTML=`<div class="filter ${activeFilter==='all'?'active':''}" onclick="activeFilter='all';render()">All ${items.length}</div>${Object.entries(typeCounts).map(([id,n])=>`<div class="filter ${activeFilter===id?'active':''}" onclick="activeFilter='${id}';render()">${TYPES[id]?.icon||'üì±'} ${n}</div>`).join('')}`;
    
    const q=document.getElementById('search').value.toLowerCase();
    let filtered=items;
    if(q)filtered=items.filter(i=>(i.title||'').toLowerCase().includes(q));
    // Filter groups - some filters include multiple types
    const filterGroups={
        'receipt':['receipt','bill','transfer'],
        'food':['food','cafe'],
        'place':['place','travel']
    };
    if(activeFilter!=='all'){
        const types=filterGroups[activeFilter]||[activeFilter];
        filtered=filtered.filter(i=>types.includes(i.typeId));
    }
    
    document.getElementById('browse-content').innerHTML=filtered.length?`<div class="grid">${filtered.map(i=>`<div class="grid-item" onclick="openModal(${i.id})"><img src="${i.uri}">${i.isDuplicate?'<div class="grid-dupe">DUPE</div>':''}<div class="grid-overlay">${i.noAI?'<div class="grid-type" style="color:#666">üì∑ No AI</div>':`<div class="grid-type" style="color:${i.type?.color||'#666'}">${i.type?.icon} ${i.type?.label}</div>`}<div class="grid-title">${i.noAI?'Screenshot':i.title||'Untitled'}</div>${!i.noAI&&i.smartTags?.length?`<div class="grid-tags">${i.smartTags.map(t=>`<span class="grid-tag">${t}</span>`).join('')}</div>`:''}<div class="grid-meta">${!i.noAI&&i.amountConverted?`<span class="grid-amount">${formatCurrency(i.amountConverted,settings.baseCurrency)}</span>`:'<span></span>'}<span class="grid-time">${timeAgo(i.time)}</span></div></div></div>`).join('')}</div>`:'<div class="empty"><div class="empty-title">No items</div></div>';
    
    renderPlaces();
    const size=new Blob([JSON.stringify(items)]).size;
    document.getElementById('storage-used').textContent=`${(size/1024/1024).toFixed(2)} MB`;
}

loadSettings();render();
</script>
</body>
</html>
