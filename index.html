<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Screenshot-first expense tracker. Snap it, stash it, track it.">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <title>STASH'D ‚Äî Screenshot Expense Tracker</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        *:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
        :root{
            --bg:#000;--card:#0d0d0d;--card2:#161616;--card3:#1a1a1a;
            --border:#222;--border2:#333;
            --text:#fff;--text2:#888;--text3:#555;
            --accent:#f97316;--accent2:#fb923c;
            --green:#22c55e;--red:#ef4444;--blue:#3b82f6;
            --purple:#a855f7;--pink:#ec4899;--yellow:#eab308;--cyan:#06b6d4;
            --gradient:linear-gradient(135deg,var(--accent),var(--pink));
        }
        html,body{height:100%;font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;font-size:15px;line-height:1.5}
        
        /* App Container */
        .app{height:100%;max-width:430px;margin:0 auto;display:flex;flex-direction:column;position:relative}
        .screen{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:100px;scroll-behavior:smooth}
        .screen.hidden{display:none}
        
        /* Header */
        .header{padding:20px;padding-top:max(20px,calc(env(safe-area-inset-top) + 8px));position:sticky;top:0;background:var(--bg);z-index:10}
        .header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
        .logo{display:flex;align-items:center;gap:10px}
        .logo-icon{width:32px;height:32px;background:var(--gradient);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .logo-text{font-size:24px;font-weight:800;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.5px}
        .header-sub{font-size:13px;color:var(--text2);margin-left:42px}
        
        /* Buttons */
        .btn{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:12px 18px;color:var(--text);font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.2s}
        .btn:active{transform:scale(0.96)}
        .btn svg{width:18px;height:18px}
        .btn-primary{background:var(--text);color:var(--bg);border-color:var(--text)}
        .btn-accent{background:var(--accent);color:var(--text);border-color:var(--accent)}
        .btn-ghost{background:transparent;border-color:transparent}
        .btn-sm{padding:8px 14px;font-size:13px;border-radius:10px}
        .btn-sm svg{width:16px;height:16px}
        
        /* Hero Stats */
        .hero{text-align:center;padding:30px 20px;background:var(--card);border-radius:24px;margin:0 16px 20px;border:1px solid var(--border)}
        .hero-label{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
        .hero-value{font-size:52px;font-weight:800;letter-spacing:-2px;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .hero-sub{font-size:14px;color:var(--text2);margin-top:4px}
        .hero-trend{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;margin-top:12px}
        .hero-trend.up{background:rgba(34,197,94,0.15);color:var(--green)}
        .hero-trend.down{background:rgba(239,68,68,0.15);color:var(--red)}
        
        /* Quick Stats */
        .quick-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:0 16px 20px}
        .quick-stat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 10px;text-align:center;cursor:pointer;transition:all 0.2s}
        .quick-stat:active{transform:scale(0.96);background:var(--card2)}
        .quick-stat-icon{font-size:22px;margin-bottom:4px}
        .quick-stat-num{font-size:20px;font-weight:700}
        .quick-stat-label{font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-top:2px}
        
        /* Budget Section */
        .budget-card{background:var(--card);border:1px solid var(--border);border-radius:16px;margin:0 16px 20px;padding:16px;overflow:hidden}
        .budget-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .budget-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
        .budget-amount{font-size:13px;color:var(--text2)}
        .budget-bar{height:8px;background:var(--card2);border-radius:4px;overflow:hidden;margin-bottom:8px}
        .budget-fill{height:100%;border-radius:4px;transition:width 0.3s}
        .budget-fill.ok{background:var(--green)}
        .budget-fill.warning{background:var(--yellow)}
        .budget-fill.danger{background:var(--red)}
        .budget-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--text2)}
        .budget-remaining{font-weight:600}
        .budget-remaining.ok{color:var(--green)}
        .budget-remaining.warning{color:var(--yellow)}
        .budget-remaining.danger{color:var(--red)}
        
        /* Reminders Section */
        .reminders{padding:0 16px 20px}
        .reminder-card{background:linear-gradient(135deg,rgba(249,115,22,0.15),rgba(236,72,153,0.1));border:1px solid rgba(249,115,22,0.3);border-radius:14px;padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:12px;cursor:pointer}
        .reminder-card:active{opacity:0.8}
        .reminder-icon{width:40px;height:40px;background:var(--card);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .reminder-content{flex:1}
        .reminder-title{font-size:14px;font-weight:600;margin-bottom:2px}
        .reminder-sub{font-size:12px;color:var(--text2)}
        .reminder-action{font-size:12px;color:var(--accent);font-weight:600}
        
        /* Section Headers */
        .section-header{display:flex;align-items:center;justify-content:space-between;padding:0 20px 12px}
        .section-title{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;font-weight:600}
        .section-action{font-size:13px;color:var(--accent);cursor:pointer;font-weight:500}
        
        /* Item List */
        .item-list{padding:0 16px}
        .list-item{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all 0.2s}
        .list-item:active{transform:scale(0.98);background:var(--card2)}
        .list-thumb{width:56px;height:56px;border-radius:12px;object-fit:cover;background:var(--card2);flex-shrink:0}
        .list-content{flex:1;min-width:0}
        .list-title{font-weight:600;font-size:15px;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .list-sub{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:6px;flex-wrap:wrap}
        .list-tag{display:inline-flex;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600}
        .list-amount{font-weight:700;font-size:16px;color:var(--green);text-align:right}
        .list-amount.expense{color:var(--red)}
        .list-time{font-size:11px;color:var(--text3);margin-top:2px}
        
        /* Search */
        .search-container{padding:0 16px 16px}
        .search-box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:12px}
        .search-box svg{width:20px;height:20px;color:var(--text3);flex-shrink:0}
        .search-box input{flex:1;background:none;border:none;color:var(--text);font-size:15px;outline:none}
        .search-box input::placeholder{color:var(--text3)}
        
        /* Filters */
        .filters{display:flex;gap:8px;padding:0 16px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
        .filters::-webkit-scrollbar{display:none}
        .filter{background:var(--card);border:1px solid var(--border);border-radius:100px;padding:10px 16px;font-size:13px;font-weight:500;color:var(--text2);white-space:nowrap;cursor:pointer;transition:all 0.2s;flex-shrink:0}
        .filter:active{transform:scale(0.96)}
        .filter.active{background:var(--text);color:var(--bg);border-color:var(--text)}
        
        /* Grid View */
        .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;padding:0 4px}
        .grid-item{position:relative;aspect-ratio:1;overflow:hidden;background:var(--card);border-radius:12px;cursor:pointer}
        .grid-item img{width:100%;height:100%;object-fit:cover;transition:transform 0.3s}
        .grid-item:active img{transform:scale(1.05)}
        .grid-overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.9) 0%,transparent 50%);padding:12px;display:flex;flex-direction:column;justify-content:flex-end}
        .grid-type{display:inline-flex;align-items:center;gap:4px;background:rgba(0,0,0,0.6);backdrop-filter:blur(10px);padding:4px 8px;border-radius:6px;font-size:10px;font-weight:600;width:fit-content;margin-bottom:6px}
        .grid-title{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .grid-amount{font-size:12px;font-weight:700;color:var(--green);margin-top:2px}
        
        /* Tabs */
        .tabs{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:8px 20px;padding-bottom:calc(8px + env(safe-area-inset-bottom));display:flex;justify-content:center;z-index:100}
        .tabs-inner{display:flex;max-width:430px;width:100%;justify-content:space-around}
        .tab{display:flex;flex-direction:column;align-items:center;padding:8px 16px;cursor:pointer;border-radius:12px;transition:all 0.2s}
        .tab:active{transform:scale(0.95)}
        .tab svg{width:24px;height:24px;color:var(--text3);stroke-width:1.8;margin-bottom:4px;transition:color 0.2s}
        .tab span{font-size:10px;font-weight:500;color:var(--text3);transition:color 0.2s}
        .tab.active svg{color:var(--accent)}
        .tab.active span{color:var(--accent)}
        
        /* Modals */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:200;display:none;flex-direction:column}
        .modal.show{display:flex}
        .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;padding-top:max(16px,env(safe-area-inset-top))}
        .modal-close{width:40px;height:40px;background:var(--card2);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text)}
        .modal-close svg{width:20px;height:20px}
        .modal-img{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;min-height:0}
        .modal-img img{max-width:100%;max-height:100%;object-fit:contain;border-radius:16px}
        .modal-info{background:var(--card);border-top:1px solid var(--border);padding:24px 20px;padding-bottom:max(24px,env(safe-area-inset-bottom))}
        .modal-type{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:10px;font-size:13px;font-weight:600;margin-bottom:12px}
        .modal-title{font-size:22px;font-weight:700;margin-bottom:4px}
        .modal-subtitle{color:var(--text2);margin-bottom:16px;font-size:14px}
        .modal-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .modal-btn{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:14px;color:var(--text);font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s}
        .modal-btn:active{transform:scale(0.96)}
        .modal-btn svg{width:18px;height:18px}
        .modal-btn.primary{background:var(--text);color:var(--bg);border-color:var(--text)}
        .modal-btn.danger{background:rgba(239,68,68,0.15);border-color:var(--red);color:var(--red)}
        
        /* Toast */
        .toast{position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--card);border:1px solid var(--border);padding:14px 24px;border-radius:14px;font-size:14px;font-weight:500;opacity:0;transition:all 0.3s;z-index:300;display:flex;align-items:center;gap:10px;max-width:90%}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        
        /* Empty State */
        .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 40px;text-align:center}
        .empty-icon{font-size:64px;margin-bottom:16px;opacity:0.5}
        .empty-title{font-size:20px;font-weight:700;margin-bottom:8px}
        .empty-text{color:var(--text2);font-size:14px;margin-bottom:24px;max-width:260px;line-height:1.6}
        
        /* Progress */
        .progress-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:400;display:none;align-items:center;justify-content:center}
        .progress-overlay.show{display:flex}
        .progress-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;text-align:center;min-width:200px}
        .progress-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .progress-text{font-size:15px;font-weight:600}
        .progress-pct{font-size:28px;font-weight:800;color:var(--accent);margin-top:8px}
        
        /* Settings */
        .settings-group{background:var(--card);border:1px solid var(--border);border-radius:16px;margin:0 16px 16px;overflow:hidden}
        .settings-item{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;gap:12px}
        .settings-item:not(:last-child){border-bottom:1px solid var(--border)}
        .settings-left{display:flex;align-items:center;gap:14px;flex:1;min-width:0}
        .settings-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px}
        .settings-text{flex:1;min-width:0}
        .settings-label{font-size:15px;font-weight:500}
        .settings-desc{font-size:12px;color:var(--text2);margin-top:2px}
        .settings-value{font-size:14px;color:var(--text2);cursor:pointer}
        .settings-input{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:14px;width:80px;text-align:right}
        .toggle{width:52px;height:32px;background:var(--card2);border:1px solid var(--border);border-radius:16px;position:relative;cursor:pointer;flex-shrink:0;transition:all 0.2s}
        .toggle.on{background:var(--green);border-color:var(--green)}
        .toggle::after{content:'';position:absolute;width:26px;height:26px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform 0.2s}
        .toggle.on::after{transform:translateX(20px)}
        
        /* Split Bill Modal */
        .split-modal{position:fixed;inset:0;background:var(--bg);z-index:250;display:none;flex-direction:column}
        .split-modal.show{display:flex}
        .split-header{padding:20px;padding-top:max(20px,env(safe-area-inset-top));border-bottom:1px solid var(--border)}
        .split-title{font-size:20px;font-weight:700}
        .split-body{flex:1;overflow-y:auto;padding:20px}
        .split-total{text-align:center;padding:20px;background:var(--card);border-radius:16px;margin-bottom:20px}
        .split-total-label{font-size:12px;color:var(--text2);margin-bottom:4px}
        .split-total-value{font-size:36px;font-weight:800}
        .split-person{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:14px}
        .split-avatar{width:44px;height:44px;background:var(--gradient);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--text)}
        .split-name{flex:1;font-weight:600}
        .split-amount{font-size:18px;font-weight:700;color:var(--accent)}
        .split-footer{padding:20px;padding-bottom:max(20px,env(safe-area-inset-bottom));border-top:1px solid var(--border)}
        
        /* Wrapped/Stats View */
        .wrapped{min-height:100%;background:var(--gradient);padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
        .wrapped-card{background:rgba(0,0,0,0.4);backdrop-filter:blur(20px);border-radius:24px;padding:32px 24px;max-width:320px;width:100%}
        .wrapped-emoji{font-size:64px;margin-bottom:16px}
        .wrapped-title{font-size:32px;font-weight:800;margin-bottom:8px}
        .wrapped-value{font-size:48px;font-weight:800;margin-bottom:8px}
        .wrapped-sub{font-size:14px;opacity:0.8}
        .wrapped-share{margin-top:24px}
        
        /* Inputs */
        input[type="file"]{display:none}
        select{appearance:none;background:var(--card2) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E") no-repeat right 12px center;padding-right:32px}
    </style>
</head>
<body>
    <div class="app">
        <!-- Progress Overlay -->
        <div class="progress-overlay" id="progress">
            <div class="progress-box">
                <div class="progress-spinner"></div>
                <div class="progress-text">Processing...</div>
                <div class="progress-pct" id="progress-pct">0%</div>
            </div>
        </div>
        
        <!-- HOME SCREEN -->
        <div class="screen" id="home">
            <div class="header">
                <div class="header-row">
                    <div class="logo">
                        <div class="logo-icon">üì∏</div>
                        <span class="logo-text">STASH'D</span>
                    </div>
                    <button class="btn btn-primary" onclick="pickFiles()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        Add
                    </button>
                </div>
                <p class="header-sub">Screenshot-first expense tracker</p>
            </div>
            
            <!-- Hero Stats -->
            <div class="hero">
                <div class="hero-label">This Month</div>
                <div class="hero-value" id="hero-total">$0</div>
                <div class="hero-sub"><span id="hero-count">0</span> items tracked</div>
                <div class="hero-trend down" id="hero-trend">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                    <span id="hero-trend-text">12% vs last month</span>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="quick-stats" id="quick-stats">
                <div class="quick-stat" onclick="filterBy('receipt')">
                    <div class="quick-stat-icon">üßæ</div>
                    <div class="quick-stat-num" id="stat-receipts">0</div>
                    <div class="quick-stat-label">Receipts</div>
                </div>
                <div class="quick-stat" onclick="filterBy('bill')">
                    <div class="quick-stat-icon">üìÑ</div>
                    <div class="quick-stat-num" id="stat-bills">0</div>
                    <div class="quick-stat-label">Bills</div>
                </div>
                <div class="quick-stat" onclick="filterBy('product')">
                    <div class="quick-stat-icon">üõçÔ∏è</div>
                    <div class="quick-stat-num" id="stat-wants">0</div>
                    <div class="quick-stat-label">Wants</div>
                </div>
                <div class="quick-stat" onclick="showWrapped()">
                    <div class="quick-stat-icon">üìä</div>
                    <div class="quick-stat-num" id="stat-all">0</div>
                    <div class="quick-stat-label">Total</div>
                </div>
            </div>
            
            <!-- Budget Card -->
            <div class="budget-card" id="budget-card">
                <div class="budget-header">
                    <div class="budget-title">üí∞ Monthly Budget</div>
                    <button class="btn btn-ghost btn-sm" onclick="editBudget()">Edit</button>
                </div>
                <div class="budget-bar">
                    <div class="budget-fill ok" id="budget-fill" style="width:45%"></div>
                </div>
                <div class="budget-meta">
                    <span><span id="budget-spent">$0</span> of <span id="budget-limit">$500</span></span>
                    <span class="budget-remaining ok" id="budget-remaining">$275 left</span>
                </div>
            </div>
            
            <!-- Reminders -->
            <div class="reminders" id="reminders">
                <!-- Dynamic reminders will appear here -->
            </div>
            
            <!-- Recent Items -->
            <div class="section-header">
                <span class="section-title">Recent</span>
                <span class="section-action" onclick="switchTab('browse')">See All</span>
            </div>
            <div class="item-list" id="home-recent"></div>
        </div>
        
        <!-- BROWSE SCREEN -->
        <div class="screen hidden" id="browse">
            <div class="header">
                <h1 style="font-size:24px;font-weight:700">Browse</h1>
            </div>
            <div class="search-container">
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <input type="text" placeholder="Search screenshots..." id="search" oninput="renderBrowse()">
                </div>
            </div>
            <div class="filters" id="filters">
                <div class="filter active" data-filter="all" onclick="setFilter('all',this)">All</div>
                <div class="filter" data-filter="receipt" onclick="setFilter('receipt',this)">üßæ Receipts</div>
                <div class="filter" data-filter="bill" onclick="setFilter('bill',this)">üìÑ Bills</div>
                <div class="filter" data-filter="product" onclick="setFilter('product',this)">üõçÔ∏è Wants</div>
                <div class="filter" data-filter="food" onclick="setFilter('food',this)">üçú Food</div>
                <div class="filter" data-filter="screenshot" onclick="setFilter('screenshot',this)">üì± Other</div>
            </div>
            <div id="browse-content"></div>
        </div>
        
        <!-- INSIGHTS SCREEN -->
        <div class="screen hidden" id="insights">
            <div class="header">
                <h1 style="font-size:24px;font-weight:700">Insights</h1>
            </div>
            <div id="insights-content">
                <!-- Analytics, trends, spending breakdown -->
            </div>
        </div>
        
        <!-- SETTINGS SCREEN -->
        <div class="screen hidden" id="settings">
            <div class="header">
                <h1 style="font-size:24px;font-weight:700">Settings</h1>
            </div>
            
            <div class="section-header"><span class="section-title">Smart Features</span></div>
            <div class="settings-group">
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:linear-gradient(135deg,#8b5cf6,#ec4899)">ü§ñ</div>
                        <div class="settings-text">
                            <div class="settings-label">AI Classification</div>
                            <div class="settings-desc">Auto-categorize screenshots</div>
                        </div>
                    </div>
                    <div class="toggle on" id="ai-toggle" onclick="toggleSetting('useAI')"></div>
                </div>
                <div class="settings-item" id="api-key-row">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:#10a37f">üîë</div>
                        <div class="settings-text">
                            <div class="settings-label">OpenAI API Key</div>
                            <div class="settings-desc">Optional - for better accuracy</div>
                        </div>
                    </div>
                    <input type="password" class="settings-input" id="api-key" placeholder="sk-..." style="width:90px">
                </div>
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:var(--cyan)">üîç</div>
                        <div class="settings-text">
                            <div class="settings-label">Duplicate Detection</div>
                            <div class="settings-desc">Skip already-saved screenshots</div>
                        </div>
                    </div>
                    <div class="toggle on" id="dupe-toggle" onclick="toggleSetting('duplicateDetection')"></div>
                </div>
            </div>
            
            <div class="section-header"><span class="section-title">Budget</span></div>
            <div class="settings-group">
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:var(--green)">üí∞</div>
                        <div class="settings-text">
                            <div class="settings-label">Monthly Budget</div>
                            <div class="settings-desc">Get alerts at 80% and 100%</div>
                        </div>
                    </div>
                    <input type="number" class="settings-input" id="budget-input" placeholder="500" oninput="saveBudget()">
                </div>
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:var(--yellow)">üí±</div>
                        <div class="settings-text">
                            <div class="settings-label">Currency</div>
                        </div>
                    </div>
                    <select class="settings-input" id="currency-select" onchange="saveCurrency()">
                        <option value="USD">USD</option>
                        <option value="THB">THB</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
            </div>
            
            <div class="section-header"><span class="section-title">Data</span></div>
            <div class="settings-group">
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:var(--blue)">üì§</div>
                        <div class="settings-text">
                            <div class="settings-label">Export Backup</div>
                        </div>
                    </div>
                    <span class="settings-value" onclick="exportData()">Export ‚Üí</span>
                </div>
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:var(--green)">üì•</div>
                        <div class="settings-text">
                            <div class="settings-label">Import Backup</div>
                        </div>
                    </div>
                    <span class="settings-value" onclick="importData()">Import ‚Üí</span>
                </div>
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:var(--yellow)">üîß</div>
                        <div class="settings-text">
                            <div class="settings-label">Repair Data</div>
                            <div class="settings-desc">Fix broken images</div>
                        </div>
                    </div>
                    <span class="settings-value" onclick="repairData()">Repair ‚Üí</span>
                </div>
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:var(--red)">üóëÔ∏è</div>
                        <div class="settings-text">
                            <div class="settings-label">Clear All Data</div>
                        </div>
                    </div>
                    <span class="settings-value" onclick="clearAllData()">Clear ‚Üí</span>
                </div>
            </div>
            
            <div class="section-header"><span class="section-title">About</span></div>
            <div class="settings-group">
                <div class="settings-item">
                    <div class="settings-left">
                        <div class="settings-icon" style="background:var(--accent)">üì∏</div>
                        <div class="settings-text">
                            <div class="settings-label">STASH'D v2.0</div>
                            <div class="settings-desc">Screenshot-first expense tracker</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Tabs -->
        <div class="tabs">
            <div class="tabs-inner">
                <div class="tab active" data-tab="home" onclick="switchTab('home')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                    <span>Home</span>
                </div>
                <div class="tab" data-tab="browse" onclick="switchTab('browse')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    <span>Browse</span>
                </div>
                <div class="tab" data-tab="insights" onclick="switchTab('insights')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                    <span>Insights</span>
                </div>
                <div class="tab" data-tab="settings" onclick="switchTab('settings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
                    <span>Settings</span>
                </div>
            </div>
        </div>
        
        <!-- Item Modal -->
        <div class="modal" id="item-modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <button class="modal-close" onclick="deleteItem()" style="background:rgba(239,68,68,0.2);color:var(--red)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>
            <div class="modal-img">
                <img id="modal-image" src="">
            </div>
            <div class="modal-info">
                <div class="modal-type" id="modal-type"></div>
                <div class="modal-title" id="modal-title"></div>
                <div class="modal-subtitle" id="modal-subtitle"></div>
                <div class="modal-actions">
                    <button class="modal-btn" onclick="editItem()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        Edit
                    </button>
                    <button class="modal-btn" onclick="splitBill()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 3h5v5M8 3H3v5M3 16v5h5M21 16v5h-5M12 8v8M8 12h8"/></svg>
                        Split
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Toast -->
        <div class="toast" id="toast"></div>
    </div>
    
    <input type="file" id="file-input" accept="image/*" multiple>
    <input type="file" id="import-input" accept=".json">
    
<script>
// ============ DATA ============
let items = JSON.parse(localStorage.getItem('stashd_items') || '[]');
let settings = JSON.parse(localStorage.getItem('stashd_settings') || '{}');
let currentFilter = 'all';
let currentItemId = null;

// Defaults
settings.useAI = settings.useAI !== false;
settings.duplicateDetection = settings.duplicateDetection !== false;
settings.budget = settings.budget || 500;
settings.currency = settings.currency || 'USD';
settings.exchangeRate = settings.exchangeRate || 35.5;

// Type definitions
const TYPES = {
    receipt: { icon: 'üßæ', label: 'Receipt', color: '#22c55e' },
    bill: { icon: 'üìÑ', label: 'Bill', color: '#ef4444' },
    product: { icon: 'üõçÔ∏è', label: 'Want', color: '#f97316' },
    food: { icon: 'üçú', label: 'Food', color: '#ec4899' },
    cafe: { icon: '‚òï', label: 'Cafe', color: '#8b5cf6' },
    place: { icon: 'üìç', label: 'Place', color: '#3b82f6' },
    travel: { icon: '‚úàÔ∏è', label: 'Travel', color: '#06b6d4' },
    transfer: { icon: 'üí∏', label: 'Transfer', color: '#a855f7' },
    screenshot: { icon: 'üì±', label: 'Screenshot', color: '#6b7280' }
};

// ============ UTILITIES ============
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

function formatCurrency(amount) {
    const symbols = { USD: '$', THB: '‡∏ø', EUR: '‚Ç¨' };
    return (symbols[settings.currency] || '$') + Math.abs(amount).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function timeAgo(timestamp) {
    const mins = Math.floor((Date.now() - timestamp) / 60000);
    if (mins < 1) return 'now';
    if (mins < 60) return mins + 'm';
    if (mins < 1440) return Math.floor(mins / 60) + 'h';
    return Math.floor(mins / 1440) + 'd';
}

function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = '‚úì ' + msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

function showProgress(show, pct = 0) {
    const el = document.getElementById('progress');
    if (show) {
        el.classList.add('show');
        document.getElementById('progress-pct').textContent = pct + '%';
    } else {
        el.classList.remove('show');
    }
}

// ============ THAI BANK PARSING ============
const THAI_BANK_PATTERNS = [
    // K+ (Kasikorn)
    { regex: /‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô|‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô|K\s*PLUS|KBank/i, bank: 'KBank' },
    { regex: /(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)\s*(?:‡∏ö‡∏≤‡∏ó|THB|‡∏ø)/i, amount: true },
    // SCB
    { regex: /SCB|‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå|Siam Commercial/i, bank: 'SCB' },
    // Bangkok Bank
    { regex: /Bangkok Bank|‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û|BBL/i, bank: 'BBL' },
    // PromptPay
    { regex: /PromptPay|‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå/i, type: 'transfer' },
    // General amount pattern
    { regex: /(?:THB|‡∏ø|‡∏ö‡∏≤‡∏ó)\s*(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/i, amount: true }
];

function parseThaiBank(text) {
    let result = { type: 'transfer', amount: null, bank: null };
    
    for (const pattern of THAI_BANK_PATTERNS) {
        const match = text.match(pattern.regex);
        if (match) {
            if (pattern.bank) result.bank = pattern.bank;
            if (pattern.type) result.type = pattern.type;
            if (pattern.amount && match[1]) {
                result.amount = parseFloat(match[1].replace(/,/g, ''));
            }
        }
    }
    
    return result;
}

// ============ AI CLASSIFICATION ============
async function classifyImage(imageData) {
    const apiKey = localStorage.getItem('stashd_apikey');
    
    // Try AI classification if enabled and key exists
    if (settings.useAI && apiKey) {
        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{
                        role: 'user',
                        content: [{
                            type: 'text',
                            text: `Analyze this image. Return ONLY valid JSON:
{"type":"receipt|bill|product|food|cafe|travel|transfer|screenshot","title":"specific merchant or item name","amount":number_or_null,"currency":"THB|USD|EUR"}

Rules:
- type: receipt=purchase, bill=utility, product=item for sale, food=restaurant, cafe=coffee, travel=booking, transfer=bank, screenshot=other
- title: Be specific (e.g. "Starbucks Central World" not just "Coffee")
- amount: Extract exact number if visible, null if not
- For Thai bank notifications (K+, SCB, BBL), extract transfer amount`
                        }, {
                            type: 'image_url',
                            image_url: { url: imageData, detail: 'low' }
                        }]
                    }],
                    max_tokens: 150
                })
            });
            
            const data = await response.json();
            if (data.choices?.[0]?.message?.content) {
                const match = data.choices[0].message.content.match(/\{[\s\S]*\}/);
                if (match) {
                    return JSON.parse(match[0]);
                }
            }
        } catch (err) {
            console.error('AI error:', err);
        }
    }
    
    // Fallback: basic classification
    return { type: 'screenshot', title: 'Screenshot', amount: null, currency: null };
}

// ============ IMAGE PROCESSING ============
async function compressImage(dataUrl, maxWidth = 600, quality = 0.5) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h = h * (maxWidth / w); w = maxWidth; }
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = () => resolve(dataUrl);
        img.src = dataUrl;
    });
}

function imageHash(dataUrl) {
    let hash = 0;
    const s = dataUrl.slice(-500);
    for (let i = 0; i < s.length; i++) {
        hash = ((hash << 5) - hash) + s.charCodeAt(i);
        hash |= 0;
    }
    return hash.toString(36);
}

// ============ FILE HANDLING ============
function pickFiles() {
    document.getElementById('file-input').click();
}

document.getElementById('file-input').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files).slice(0, 10);
    if (!files.length) return;
    
    showProgress(true, 0);
    
    for (let i = 0; i < files.length; i++) {
        showProgress(true, Math.round((i / files.length) * 100));
        
        const reader = new FileReader();
        const dataUrl = await new Promise(resolve => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(files[i]);
        });
        
        // Compress
        const compressed = await compressImage(dataUrl);
        const hash = imageHash(compressed);
        
        // Check duplicate
        if (settings.duplicateDetection && items.find(item => item.hash === hash)) {
            continue; // Skip duplicate
        }
        
        // Classify
        const classification = await classifyImage(compressed);
        
        // Create item
        const item = {
            id: Date.now() + Math.random(),
            uri: compressed,
            hash: hash,
            time: Date.now(),
            typeId: classification.type || 'screenshot',
            title: classification.title || 'Screenshot',
            amount: classification.amount,
            currency: classification.currency || settings.currency
        };
        
        items.unshift(item);
    }
    
    saveItems();
    render();
    showProgress(false);
    toast(`Added ${files.length} item${files.length > 1 ? 's' : ''}`);
    
    e.target.value = '';
});

// ============ DATA PERSISTENCE ============
function saveItems() {
    try {
        localStorage.setItem('stashd_items', JSON.stringify(items));
    } catch (err) {
        // Storage full - remove oldest items
        while (items.length > 10) {
            items.pop();
        }
        localStorage.setItem('stashd_items', JSON.stringify(items));
        toast('Storage full - older items removed');
    }
}

function saveSettings() {
    localStorage.setItem('stashd_settings', JSON.stringify(settings));
}

// ============ RENDERING ============
function render() {
    renderHome();
    renderBrowse();
    renderSettings();
}

function renderHome() {
    // Calculate totals
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const monthItems = items.filter(i => i.time >= monthStart && i.amount);
    const total = monthItems.reduce((sum, i) => sum + (i.amount || 0), 0);
    
    // Hero stats
    document.getElementById('hero-total').textContent = formatCurrency(total);
    document.getElementById('hero-count').textContent = items.length;
    
    // Quick stats
    document.getElementById('stat-receipts').textContent = items.filter(i => i.typeId === 'receipt').length;
    document.getElementById('stat-bills').textContent = items.filter(i => i.typeId === 'bill').length;
    document.getElementById('stat-wants').textContent = items.filter(i => i.typeId === 'product').length;
    document.getElementById('stat-all').textContent = items.length;
    
    // Budget
    const budget = settings.budget || 500;
    const pct = Math.min(100, (total / budget) * 100);
    const remaining = budget - total;
    
    document.getElementById('budget-spent').textContent = formatCurrency(total);
    document.getElementById('budget-limit').textContent = formatCurrency(budget);
    document.getElementById('budget-remaining').textContent = formatCurrency(Math.abs(remaining)) + (remaining >= 0 ? ' left' : ' over');
    
    const fill = document.getElementById('budget-fill');
    fill.style.width = pct + '%';
    fill.className = 'budget-fill ' + (pct < 80 ? 'ok' : pct < 100 ? 'warning' : 'danger');
    
    const remainingEl = document.getElementById('budget-remaining');
    remainingEl.className = 'budget-remaining ' + (pct < 80 ? 'ok' : pct < 100 ? 'warning' : 'danger');
    
    // Reminders
    renderReminders();
    
    // Recent items
    const recent = items.slice(0, 5);
    document.getElementById('home-recent').innerHTML = recent.length ? recent.map(item => {
        const type = TYPES[item.typeId] || TYPES.screenshot;
        return `
            <div class="list-item" onclick="openItem(${item.id})">
                <img src="${item.uri}" class="list-thumb" onerror="this.style.display='none'">
                <div class="list-content">
                    <div class="list-title">${escapeHtml(item.title)}</div>
                    <div class="list-sub">
                        <span class="list-tag" style="background:${type.color}20;color:${type.color}">${type.icon} ${type.label}</span>
                        <span>${timeAgo(item.time)}</span>
                    </div>
                </div>
                ${item.amount ? `<div class="list-amount">${formatCurrency(item.amount)}</div>` : ''}
            </div>
        `;
    }).join('') : `
        <div class="empty">
            <div class="empty-icon">üì∏</div>
            <div class="empty-title">No screenshots yet</div>
            <div class="empty-text">Tap + to add your first screenshot</div>
        </div>
    `;
}

function renderReminders() {
    // Check for upcoming bills/due dates
    const reminders = [];
    
    // Check budget warning
    const monthItems = items.filter(i => {
        const d = new Date(i.time);
        const now = new Date();
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear() && i.amount;
    });
    const spent = monthItems.reduce((sum, i) => sum + (i.amount || 0), 0);
    const pct = (spent / (settings.budget || 500)) * 100;
    
    if (pct >= 80 && pct < 100) {
        reminders.push({
            icon: '‚ö†Ô∏è',
            title: 'Budget Alert',
            sub: `You've used ${Math.round(pct)}% of your monthly budget`,
            action: 'View spending'
        });
    } else if (pct >= 100) {
        reminders.push({
            icon: 'üö®',
            title: 'Over Budget!',
            sub: `You're ${formatCurrency(spent - (settings.budget || 500))} over budget`,
            action: 'Review expenses'
        });
    }
    
    // Check for bills (items with "bill" type in last 30 days that might be recurring)
    const recentBills = items.filter(i => i.typeId === 'bill' && Date.now() - i.time < 30 * 24 * 60 * 60 * 1000);
    if (recentBills.length > 0) {
        reminders.push({
            icon: 'üìÑ',
            title: `${recentBills.length} bill${recentBills.length > 1 ? 's' : ''} this month`,
            sub: 'Review your recurring expenses',
            action: 'View bills'
        });
    }
    
    document.getElementById('reminders').innerHTML = reminders.map(r => `
        <div class="reminder-card">
            <div class="reminder-icon">${r.icon}</div>
            <div class="reminder-content">
                <div class="reminder-title">${r.title}</div>
                <div class="reminder-sub">${r.sub}</div>
            </div>
            <div class="reminder-action">${r.action}</div>
        </div>
    `).join('');
}

function renderBrowse() {
    const query = document.getElementById('search').value.toLowerCase();
    let filtered = items;
    
    // Apply filter
    if (currentFilter !== 'all') {
        filtered = filtered.filter(i => i.typeId === currentFilter);
    }
    
    // Apply search
    if (query) {
        filtered = filtered.filter(i => (i.title || '').toLowerCase().includes(query));
    }
    
    document.getElementById('browse-content').innerHTML = filtered.length ? `
        <div class="grid">
            ${filtered.map(item => {
                const type = TYPES[item.typeId] || TYPES.screenshot;
                return `
                    <div class="grid-item" onclick="openItem(${item.id})">
                        <img src="${item.uri}" onerror="this.parentElement.style.display='none'">
                        <div class="grid-overlay">
                            <div class="grid-type" style="color:${type.color}">${type.icon} ${type.label}</div>
                            <div class="grid-title">${escapeHtml(item.title)}</div>
                            ${item.amount ? `<div class="grid-amount">${formatCurrency(item.amount)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    ` : `
        <div class="empty">
            <div class="empty-icon">üîç</div>
            <div class="empty-title">No results</div>
            <div class="empty-text">Try a different search or filter</div>
        </div>
    `;
}

function renderSettings() {
    document.getElementById('ai-toggle').className = 'toggle' + (settings.useAI ? ' on' : '');
    document.getElementById('dupe-toggle').className = 'toggle' + (settings.duplicateDetection ? ' on' : '');
    document.getElementById('budget-input').value = settings.budget || '';
    document.getElementById('currency-select').value = settings.currency || 'USD';
    
    const apiKey = localStorage.getItem('stashd_apikey') || '';
    document.getElementById('api-key').value = apiKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
}

// ============ NAVIGATION ============
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add('active');
    document.getElementById(tab)?.classList.remove('hidden');
}

function setFilter(filter, el) {
    currentFilter = filter;
    document.querySelectorAll('.filter').forEach(f => f.classList.remove('active'));
    el.classList.add('active');
    renderBrowse();
}

function filterBy(type) {
    currentFilter = type;
    switchTab('browse');
    document.querySelectorAll('.filter').forEach(f => {
        f.classList.toggle('active', f.dataset.filter === type);
    });
    renderBrowse();
}

// ============ ITEM MODAL ============
function openItem(id) {
    const item = items.find(i => i.id === id);
    if (!item) return;
    
    currentItemId = id;
    const type = TYPES[item.typeId] || TYPES.screenshot;
    
    document.getElementById('modal-image').src = item.uri;
    document.getElementById('modal-type').innerHTML = `<span style="background:${type.color}20;color:${type.color}">${type.icon} ${type.label}</span>`;
    document.getElementById('modal-title').textContent = item.title || 'Screenshot';
    document.getElementById('modal-subtitle').textContent = item.amount ? formatCurrency(item.amount) + ' ‚Ä¢ ' + timeAgo(item.time) : timeAgo(item.time);
    
    document.getElementById('item-modal').classList.add('show');
}

function closeModal() {
    document.getElementById('item-modal').classList.remove('show');
    currentItemId = null;
}

function deleteItem() {
    if (!currentItemId) return;
    if (!confirm('Delete this item?')) return;
    
    items = items.filter(i => i.id !== currentItemId);
    saveItems();
    render();
    closeModal();
    toast('Item deleted');
}

function editItem() {
    // TODO: Implement edit modal
    toast('Edit coming soon');
}

function splitBill() {
    // TODO: Implement split bill
    toast('Split bill coming soon');
}

// ============ SETTINGS ============
function toggleSetting(key) {
    settings[key] = !settings[key];
    saveSettings();
    renderSettings();
}

function saveBudget() {
    settings.budget = parseInt(document.getElementById('budget-input').value) || 500;
    saveSettings();
    render();
}

function saveCurrency() {
    settings.currency = document.getElementById('currency-select').value;
    saveSettings();
    render();
}

document.getElementById('api-key').addEventListener('change', (e) => {
    const val = e.target.value;
    if (val && val !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
        localStorage.setItem('stashd_apikey', val);
        toast('API key saved');
    }
});

// ============ DATA MANAGEMENT ============
function exportData() {
    const data = { items, settings, exported: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stashd-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Backup exported');
}

function importData() {
    document.getElementById('import-input').click();
}

document.getElementById('import-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
        const data = JSON.parse(await file.text());
        if (data.items && Array.isArray(data.items)) {
            if (confirm(`Import ${data.items.length} items?`)) {
                items = [...data.items, ...items];
                saveItems();
                render();
                toast(`Imported ${data.items.length} items`);
            }
        }
    } catch (err) {
        toast('Invalid backup file');
    }
    
    e.target.value = '';
});

function repairData() {
    const before = items.length;
    items = items.filter(i => i.uri && i.uri.startsWith('data:image/'));
    const removed = before - items.length;
    
    if (removed > 0) {
        saveItems();
        render();
        toast(`Removed ${removed} broken items`);
    } else {
        toast('No broken items found');
    }
}

function clearAllData() {
    if (!confirm('Delete ALL data? This cannot be undone.')) return;
    
    items = [];
    saveItems();
    render();
    toast('All data cleared');
}

// ============ WRAPPED/STATS ============
function showWrapped() {
    // TODO: Show spending wrapped modal
    switchTab('insights');
}

// ============ SERVICE WORKER ============
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
}

// ============ INIT ============
render();
</script>
</body>
</html>
